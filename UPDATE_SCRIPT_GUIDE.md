# 股價資料更新腳本使用指南

## 概述

`update_stock_prices.py` 是一個手動執行的腳本，用於將所有活躍股票的歷史股價資料儲存到 Google Sheets。

## 為什麼需要這個腳本？

### 問題
- ❌ 每次開啟應用程式都要即時抓取所有股票資料 → 很慢
- ❌ 無法繪製 K 線圖並標註進出場點位
- ❌ 資料不一致（每次抓取可能不同）

### 解決方案
- ✅ 將股價資料預先儲存到 Google Sheets
- ✅ 應用程式直接讀取 → 超快
- ✅ 支援 K 線圖功能
- ✅ 資料一致且可追溯

---

## 工作原理

### 1. 自動建立新工作表
腳本會在您的 Google Sheets 中建立一個名為「股價歷史」的新工作表。

### 2. 抓取活躍股票
自動偵測所有未出場部位的股票代號。

### 3. 獲取歷史資料
- 回溯 90 天的股價資料
- 使用 twstock 或 yfinance API
- 包含：開盤價、最高價、最低價、收盤價、成交量

### 4. 計算技術指標
- MA5、MA10、MA20、MA60（移動平均線）
- 兩日低點（加碼單停損用）

### 5. 儲存到 Google Sheets
- 刪除舊資料
- 寫入最新資料
- 記錄更新時間

---

## 使用方式

### 第一次執行

1. **確認環境**
   ```bash
   cd stock-strategy-app
   ```

2. **執行腳本**
   ```bash
   python update_stock_prices.py
   ```

3. **查看結果**
   - 開啟您的 Google Sheets
   - 會看到新的「股價歷史」工作表
   - 裡面有所有股票的歷史資料

### 日常使用

**建議每天收盤後執行一次**（例如下午 2:00 後）：

```bash
python update_stock_prices.py
```

---

## 輸出範例

```
============================================================
📈 股價資料更新腳本
============================================================

🔗 連線到 Google Sheets...
✅ 連線成功

📝 建立新工作表：股價歷史
✅ 工作表建立完成

📋 取得活躍股票清單...
✅ 找到 3 支股票：2330, 6770, 0050

📊 開始更新股價資料...

[1/3] 處理 2330
  📊 抓取 2330 的資料... ✅ (twstock)
  ✅ 已更新 90 筆資料

[2/3] 處理 6770
  📊 抓取 6770 的資料... ✅ (yfinance)
  ✅ 已更新 90 筆資料

[3/3] 處理 0050
  📊 抓取 0050 的資料... ✅ (twstock)
  ✅ 已更新 90 筆資料

============================================================
✅ 所有股票資料更新完成！
============================================================
```

---

## Google Sheets 資料結構

### 「股價歷史」工作表欄位

| 欄位 | 說明 | 範例 |
|------|------|------|
| 日期 | 交易日期 | 2026-01-24 |
| 股票代號 | 股票代號 | 2330 |
| 股票名稱 | 股票名稱 | 台積電 |
| 開盤價 | 開盤價 | 1050.00 |
| 最高價 | 最高價 | 1060.00 |
| 最低價 | 最低價 | 1045.00 |
| 收盤價 | 收盤價 | 1055.00 |
| 成交量 | 成交量 | 50000 |
| MA5 | 5 日均線 | 1048.50 |
| MA10 | 10 日均線 | 1045.20 |
| MA20 | 20 日均線 | 1040.80 |
| MA60 | 60 日均線 | 1035.60 |
| 兩日低 | 前兩日最低價 | 1042.00 |
| 更新時間 | 資料更新時間 | 2026-01-24 14:30:00 |

---

## 常見問題

### Q1: 需要多久執行一次？
**A:** 建議每天收盤後執行一次（下午 2:00 後）。如果當天沒有交易，可以跳過。

### Q2: 執行需要多久？
**A:** 取決於股票數量：
- 1-3 支股票：約 1-2 分鐘
- 5-10 支股票：約 3-5 分鐘

### Q3: 會覆蓋舊資料嗎？
**A:** 是的。每次執行會刪除該股票的舊資料，然後寫入最新的 90 天資料。

### Q4: 如果抓取失敗怎麼辦？
**A:** 腳本會自動嘗試兩種資料來源（twstock → yfinance）。如果都失敗，會跳過該股票並繼續處理下一支。

### Q5: 可以修改回溯天數嗎？
**A:** 可以。修改腳本中的 `LOOKBACK_DAYS` 變數（預設 90 天）。

---

## 注意事項

### ⚠️ API 限制
- Google Sheets API 有速率限制
- 腳本已加入延遲機制（每支股票間隔 1 秒）
- 如果股票很多，可能需要較長時間

### ⚠️ 資料來源
- 優先使用 twstock（台股專用）
- 如果失敗則使用 yfinance（國際通用）
- 兩者資料可能略有差異

### ⚠️ 交易日
- 只會有交易日的資料
- 週末和假日不會有資料

---

## 下一步：自動化

目前是手動執行，未來可以：

### 選項 1：Windows 工作排程器
- 設定每天下午 2:30 自動執行
- 需要電腦開機

### 選項 2：GitHub Actions（推薦）
- 完全自動化
- 不需要電腦開機
- 免費

### 選項 3：雲端服務
- Google Cloud Scheduler
- AWS Lambda
- 需要少量費用

---

## 疑難排解

### 錯誤：找不到 service_account.json
**解決方案**：確認 `service_account.json` 檔案在 `stock-strategy-app` 目錄中

### 錯誤：連線失敗
**解決方案**：
1. 檢查網路連線
2. 確認 Google Sheets URL 正確
3. 確認服務帳戶有編輯權限

### 錯誤：無法獲取股價資料
**解決方案**：
1. 檢查股票代號是否正確
2. 確認該股票當天有交易
3. 稍後再試（可能是 API 暫時無法使用）

---

## 支援

如有問題，請檢查：
1. 腳本輸出的錯誤訊息
2. Google Sheets 是否正確建立
3. 網路連線是否正常
